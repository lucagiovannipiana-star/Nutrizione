<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ðŸ¥— Diario Alimentare</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{font-family:Inter,system-ui;background:#f9fafb;margin:0;padding:14px;color:#1f2937}
.container{max-width:1100px;margin:auto}
.card{background:#ffffff;border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
input,button{padding:7px 10px;border-radius:10px;border:1px solid #cbd5e1}
button{cursor:pointer;font-weight:600}
.primary{background:#3b82f6;color:#fff;border:none}
.success{color:#16a34a;font-weight:700}
.warning{color:#dc2626;font-weight:700}
.meal-title{font-weight:700;padding:6px;border-radius:12px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
.meal-title button{font-size:0.8rem;padding:4px 8px}
.colazione{background:#fefce8}
.spuntino-m{background:#d1fae5}
.pranzo{background:#dbeafe}
.spuntino-p{background:#ede9fe}
.cena{background:#fee2e2}
table{width:100%;border-collapse:collapse;font-size:.85rem}
th,td{padding:6px;text-align:center;border-bottom:1px solid #e5e7eb}
thead th{background:#1f2937;color:#fff}
tfoot th{background:#f3f4f6}
.autocomplete{position:absolute;background:#fff;border:1px solid #3b82f6;max-height:140px;overflow:auto;display:none;z-index:1000;width:100%}
.autocomplete div{padding:4px 6px;cursor:pointer}
.autocomplete div:hover{background:#3b82f6;color:#fff}
.report-day{cursor:pointer;color:#1f2937;font-weight:600;display:block;margin:2px 0;font-size:0.85rem}
.small{font-size:.75rem;color:#475569}
.macro-wrapper{display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap}
.macro-text{font-size:0.85rem}
.macro-canvas-wrap{flex:0 0 140px;height:120px;position:relative}
#macroChart{width:100%!important;height:100%!important}
.modal-bg{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:none;justify-content:center;align-items:center;z-index:2000}
.modal{background:#fff;padding:20px;border-radius:12px;width:320px;max-width:90%}
.modal h3{margin-top:0;margin-bottom:10px;font-size:1.1rem}
.modal input{width:100%;margin-bottom:6px}
.modal button{width:100%;margin-top:6px}
</style>
</head>
<body>

<div class="container">

<!-- LOGIN -->
<div class="card controls" id="loginCard">
  <input type="text" id="username" placeholder="Inserisci il tuo nome">
  <button class="primary" onclick="login()">Login</button>
</div>

<!-- APP PRINCIPALE -->
<div id="mainApp" style="display:none;">

<h1>ðŸ¥— Diario Alimentare - <span id="userLabel"></span></h1>

<!-- Aggiungi Alimento -->
<div class="card controls">
  <button class="primary" onclick="showModal()">âž• Aggiungi Alimento al DB</button>
  <button class="primary" onclick="init()">ðŸ”„ Aggiorna Dati</button>
</div>

<!-- Controlli giorno -->
<div class="card controls">
  <input type="date" id="giorno">
  <button class="primary" onclick="loadDay()">Carica</button>
  <button onclick="saveDay()">Salva</button>
  <input type="number" id="kTarget" placeholder="Target Kcal" style="width:100px">
  <span class="small">Auto-calcolo kcal e macro</span>
</div>

<!-- Pasti -->
<div id="meals"></div>

<!-- Totale giorno compatto -->
<div class="card" style="padding:10px;">
  <div class="macro-wrapper">
    <b style="font-size:1rem;">Totale Giorno</b>
    <div id="totDay" class="macro-text">â€”</div>
    <div class="macro-canvas-wrap">
      <canvas id="macroChart"></canvas>
    </div>
  </div>
  <div class="small" id="media7gg">Media ultimi 7 giorni: â€” kcal</div>
</div>

<!-- Report compatto -->
<div class="card">
  <h3>ðŸ“Š Report Settimanale</h3>
  <canvas id="chart" style="height:180px;"></canvas>
  <div id="reportList"></div>
</div>

</div>

<!-- Modal Aggiungi Alimento -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <h3>âž• Aggiungi Alimento</h3>
    <input type="text" id="newAlimento" placeholder="Nome alimento">
    <input type="number" step="0.1" id="newCal" placeholder="Kcal">
    <input type="number" step="0.1" id="newCarb" placeholder="Carb">
    <input type="number" step="0.1" id="newProt" placeholder="Prot">
    <input type="number" step="0.1" id="newFat" placeholder="Fat">
    <button class="primary" onclick="addFoodDB()">Aggiungi</button>
    <button onclick="hideModal()">Chiudi</button>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzkA3zpFChpsh8n5eAu77tLiRzMNjnmgbh5e24Ugd5mRcFnbdnZ-sEHHd-0_sxC47h6ng/exec";
const MEALS = [
  ["Colazione","colazione"],
  ["Spuntino mattina","spuntino-m"],
  ["Pranzo","pranzo"],
  ["Spuntino pomeriggio","spuntino-p"],
  ["Cena","cena"]
];
let db=[], allDays=[], chart, macroChart;
let currentUser="";

// --- Login ---
function login(){
  const name = document.getElementById("username").value.trim();
  if(!name) return alert("Inserisci il tuo nome!");
  currentUser = name;
  document.getElementById("userLabel").textContent = currentUser;
  document.getElementById("loginCard").style.display = "none";
  document.getElementById("mainApp").style.display = "block";
  init();
}

// --- Modal ---
function showModal(){document.getElementById("modalBg").style.display="flex";}
function hideModal(){document.getElementById("modalBg").style.display="none";}

// --- API ---
async function apiFetch(action, body=null){
  const url = `${API}?action=${action}&user=${encodeURIComponent(currentUser)}`;
  const options = body? {method:"POST",body:JSON.stringify(body)}:{};
  const res = await fetch(url, options);
  return await res.json();
}

// --- Init / Aggiorna ---
async function init(){
  db = await apiFetch("getDB");
  renderMeals();
  report();
}

// --- Render pasti ---
function renderMeals(){
  const m=document.getElementById("meals"); m.innerHTML="";
  MEALS.forEach(([n,c])=>{
    m.innerHTML+=`
    <div class="card">
      <div class="meal-title ${c}">
        <span>${n}</span>
        <button type="button" onclick="addRow('${n}')">+</button>
      </div>
      <table>
        <thead><tr><th>Alimento</th><th>g</th><th>Kcal</th><th>Carb</th><th>Prot</th><th>Fat</th><th></th></tr></thead>
        <tbody id="${n}-b"></tbody>
        <tfoot>
          <tr>
            <th>Tot</th><th></th>
            <th id="${n}-c">0</th>
            <th id="${n}-cb">0</th>
            <th id="${n}-p">0</th>
            <th id="${n}-f">0</th>
            <th></th>
          </tr>
        </tfoot>
      </table>
    </div>`;
    addRow(n);
  });
}

// --- Aggiungi riga ---
function addRow(m,a={},q=100){
  const b=document.getElementById(m+"-b");
  const r=document.createElement("tr");
  r.innerHTML=`<td style="position:relative">
<input value="${a.alimento||''}" oninput="auto(this)">
<div class="autocomplete"></div>
</td>
<td><input type="number" value="${q}" onchange="calc()"></td>
<td class="c">0</td>
<td class="cb">0</td>
<td class="p">0</td>
<td class="f">0</td>
<td><button type="button" onclick="this.closest('tr').remove();calc()">âœ•</button></td>`;
  b.appendChild(r);
}

// --- Autocomplete ---
function auto(i){
  const box=i.nextElementSibling;
  const v=i.value.toLowerCase();
  box.innerHTML="";
  if(!v){box.style.display="none";return;}
  db.filter(x=>x.alimento.toLowerCase().includes(v)).slice(0,20).forEach(a=>{
    const d=document.createElement("div"); d.textContent=a.alimento;
    d.onclick=()=>{i.value=a.alimento;box.style.display="none";calc();};
    box.appendChild(d);
  });
  box.style.display="block";
}
document.addEventListener("click",e=>{
  if(!e.target.closest(".autocomplete") && !e.target.closest("td"))
    document.querySelectorAll(".autocomplete").forEach(d=>d.style.display="none");
});

// --- Calcolo nutrienti e totale ---
function calc(){
  let day={c:0,cb:0,p:0,f:0};
  MEALS.forEach(([n])=>{
    let t={c:0,cb:0,p:0,f:0};
    [...document.getElementById(n+"-b").rows].forEach(r=>{
      const a=db.find(x=>x.alimento===r.cells[0].children[0].value);
      const q=+r.cells[1].children[0].value||0;
      if(a){
        const c=a.calorie*q/100, cb=a.carboidrati*q/100, p=a.proteine*q/100, f=a.grassi*q/100;
        r.querySelector(".c").textContent=c.toFixed(1);
        r.querySelector(".cb").textContent=cb.toFixed(1);
        r.querySelector(".p").textContent=p.toFixed(1);
        r.querySelector(".f").textContent=f.toFixed(1);
        t.c+=c; t.cb+=cb; t.p+=p; t.f+=f;
      }
    });
    ["c","cb","p","f"].forEach(k=>document.getElementById(`${n}-${k}`).textContent=t[k].toFixed(1));
    day.c+=t.c; day.cb+=t.cb; day.p+=t.p; day.f+=t.f;
  });
  const kTarget = +document.getElementById("kTarget").value||0;
  const totEl = document.getElementById("totDay");
  totEl.innerHTML=`ðŸ”¥ ${day.c.toFixed(0)} kcal Â· ðŸ¥– ${day.cb.toFixed(1)} g Â· ðŸ’ª ${day.p.toFixed(1)} g Â· ðŸ§ˆ ${day.f.toFixed(1)} g`;
  totEl.className = day.c>kTarget && kTarget>0 ? "warning" : "success";

  const ctx=document.getElementById("macroChart");
  if(macroChart) macroChart.destroy();
  macroChart=new Chart(ctx,{
    type:"doughnut",
    data:{labels:["Carb","Prot","Fat"],datasets:[{data:[day.cb,day.p,day.f],backgroundColor:["#3b82f6","#16a34a","#dc2626"],borderColor:"#f9fafb",borderWidth:2}]},
    options:{responsive:true,maintainAspectRatio:false,cutout:"65%",plugins:{legend:{position:"bottom"}}}
  });

  // Media ultimi 7 giorni
  const last7 = allDays.slice(-7);
  if(last7.length>0){
    const avg = last7.reduce((a,d)=>a+d.items.reduce((s,i)=>s+i.nutrienti.cal,0),0)/last7.length;
    document.getElementById("media7gg").textContent=`Media ultimi 7 giorni: ${avg.toFixed(0)} kcal`;
  }

  return day;
}

// --- Salvataggio giorno ---
async function saveDay(){
  const date=document.getElementById("giorno").value;
  if(!date) return alert("Seleziona una data");
  const items=[];
  MEALS.forEach(([n])=>[...document.getElementById(n+"-b").rows].forEach(r=>{
    const a=r.cells[0].children[0].value;
    const q=+r.cells[1].children[0].value||0;
    const f=db.find(x=>x.alimento===a);
    if(a&&q&&f) items.push({pasto:n,alimento:a,quantita:q,nutrienti:{cal:f.calorie*q/100,carb:f.carboidrati*q/100,prot:f.proteine*q/100,fat:f.grassi*q/100}});
  }));
  const res = await apiFetch("saveDay",{date,items});
  if(res.success){alert("Giorno salvato!"); loadDay();}
  else alert(res.msg||"Errore salvataggio");
}

// --- Carica giorno selezionato ---
async function loadDay(){
  const date=document.getElementById("giorno").value;
  if(!date) return alert("Seleziona una data");
  const d=await apiFetch("getDay",{date});
  renderMeals();
  d.forEach(i=>addRow(i.pasto,i,i.quantita));
  calc();
}

// --- Report settimanale ---
async function report(){
  const d = await apiFetch("getAllDays");
  allDays = d || [];

  // Ordina le date in ordine cronologico crescente
  allDays.sort((a, b) => new Date(a.date) - new Date(b.date));

  const labels = [], K = [];
  const list = document.getElementById("reportList"); 
  list.innerHTML = "";

  allDays.forEach(x => {
    const items = Array.isArray(x.items) ? x.items : [];
    const t = items.reduce((a, i) => a + i.nutrienti.cal, 0);
    labels.push(x.date);
    K.push(t);
    list.innerHTML += `<span class="report-day" onclick="document.getElementById('giorno').value='${x.date}';loadDay()">${x.date} â†’ ${t.toFixed(0)} kcal</span>`;
  });

  if(chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "Kcal",
        data: K,
        borderColor: "#3b82f6",
        backgroundColor: "rgba(59,130,246,0.3)",
        tension: 0.2,
        fill: true
      }]
    }
  });  
}

// --- Aggiungi alimento DB ---
async function addFoodDB(){
  const a=document.getElementById("newAlimento").value.trim();
  const c=+document.getElementById("newCal").value;
  const cb=+document.getElementById("newCarb").value;
  const p=+document.getElementById("newProt").value;
  const f=+document.getElementById("newFat").value;
  if(!a||!c) return alert("Nome e Kcal obbligatori");
  if(db.find(x=>x.alimento.toLowerCase()===a.toLowerCase())) return alert("Alimento giÃ  presente nel DB");
  const newFood={alimento:a,calorie:c,carboidrati:cb||0,proteine:p||0,grassi:f||0};
  const res = await apiFetch("addFood",newFood);
  if(res.success){db.push(newFood); alert("Alimento aggiunto!"); hideModal(); init();}
  else alert(res.msg||"Errore");
}
</script>
</body>
</html>
