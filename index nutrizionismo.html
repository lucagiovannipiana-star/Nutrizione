<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ðŸ¥— Diario Alimentare</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{font-family:Inter,system-ui;background:#f8fafc;margin:0;padding:14px;color:#0f172a}
.container{max-width:1200px;margin:auto}
.card{background:#fff;border-radius:18px;padding:14px;margin-bottom:14px;box-shadow:0 6px 16px rgba(0,0,0,.08)}
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
input,button{padding:7px 10px;border-radius:10px;border:1px solid #94a3b8}
button{cursor:pointer;font-weight:600}
.primary{background:#2563eb;color:#fff;border:none}
.meal-title{font-weight:700;padding:6px;border-radius:12px;margin-bottom:6px}
.colazione{background:#FEF3C7}.spuntino-m{background:#DCFCE7}
.pranzo{background:#DBEAFE}.spuntino-p{background:#F3E8FF}.cena{background:#FEE2E2}
table{width:100%;border-collapse:collapse;font-size:.85rem}
th,td{padding:5px;text-align:center;border-bottom:1px solid #e5e7eb}
thead th{background:#0f172a;color:#fff}
tfoot th{background:#f1f5f9}
.autocomplete{position:absolute;background:#fff;border:1px solid #2563eb;max-height:140px;overflow:auto;display:none;z-index:1000}
.autocomplete div{padding:4px 6px;cursor:pointer}
.autocomplete div:hover{background:#2563eb;color:#fff}
.report-day{cursor:pointer;color:#2f3e5e;font-weight:600;display:block;margin:4px 0}
.small{font-size:.75rem;color:#475569}
</style>
</head>
<body>
<div class="container">

<h1>ðŸ¥— Diario Alimentare</h1>

<!-- Controlli -->
<div class="card controls">
<input type="date" id="giorno">
<button class="primary" onclick="loadDay()">Carica</button>
<button onclick="saveDay()">Salva</button>
<span class="small">Auto-calcolo kcal e macro</span>
</div>

<!-- Pasti -->
<div id="meals"></div>

<!-- Totale giorno compatto -->
<div class="card" style="padding:10px;">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;">
    <b style="font-size:1rem;">Totale Giorno</b>
    <div id="totDay" style="font-size:0.85rem;">â€”</div>
  </div>
  <canvas id="macroChart" height="80" style="margin-top:6px;"></canvas>
</div>


<!-- Report storico -->
<div class="card">
<h3>ðŸ“Š Report</h3>
<div class="controls">
Da <input type="date" id="from">
A <input type="date" id="to">
Kcal min <input type="number" id="kmin" style="width:80px">
max <input type="number" id="kmax" style="width:80px">
<button class="primary" onclick="report()">Filtra</button>
</div>
<canvas id="chart" height="140"></canvas>
<div id="reportList"></div>
</div>

<!-- Aggiungi alimento al DB -->
<div class="card">
<h3>âž• Aggiungi alimento al DB</h3>
<input type="text" id="newAlimento" placeholder="Nome alimento">
<input type="number" id="newCal" placeholder="Kcal">
<input type="number" id="newCarb" placeholder="Carb">
<input type="number" id="newProt" placeholder="Prot">
<input type="number" id="newFat" placeholder="Fat">
<button class="primary" onclick="addFoodDB()">Aggiungi</button>
</div>

</div>

<script>
const API="https://script.google.com/macros/s/AKfycbzALgO_J8C7jzwc1mT9YRgolmlgohRYi9UVe272oqs8GMFil0AgpS0OUflqO524EMNqiQ/exec";
const MEALS=[["Colazione","colazione"],["Spuntino mattina","spuntino-m"],["Pranzo","pranzo"],["Spuntino pomeriggio","spuntino-p"],["Cena","cena"]];
let db=[], allDays=[], chart, macroChart;

// --- Format YYYY-MM-DD
function formatDate(d){const yy=d.getFullYear(),mm=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');return `${yy}-${mm}-${dd}`}

// --- INIT ---
const giornoInput = document.getElementById("giorno");
giornoInput.value = formatDate(new Date());
fetch(API+"?action=getDB").then(r=>r.json()).then(d=>db=d);
renderMeals();
report();

// --- Render pasti ---
function renderMeals(){
  const m=document.getElementById("meals"); m.innerHTML="";
  MEALS.forEach(([n,c])=>{
    m.innerHTML+=`
    <div class="card">
    <div class="meal-title ${c}">${n} <button onclick="addRow('${n}')">+</button></div>
    <table>
    <thead><tr><th>Alimento</th><th>g</th><th>Kcal</th><th>Carb</th><th>Prot</th><th>Fat</th><th></th></tr></thead>
    <tbody id="${n}-b"></tbody>
    <tfoot><tr><th>Tot</th><th></th>
    <th id="${n}-c">0</th><th id="${n}-cb">0</th>
    <th id="${n}-p">0</th><th id="${n}-f">0</th><th></th></tr></tfoot>
    </table></div>`;
    addRow(n);
  });
}

// --- Aggiungi riga ---
function addRow(m,a={},q=100){
  const b=document.getElementById(m+"-b");
  const r=document.createElement("tr");
  r.innerHTML=`
<td style="position:relative">
<input value="${a.alimento||""}" oninput="auto(this)">
<div class="autocomplete"></div></td>
<td><input type="number" value="${q}" onchange="calc()"></td>
<td class="c">0</td><td class="cb">0</td><td class="p">0</td><td class="f">0</td>
<td><button onclick="this.closest('tr').remove();calc()">âœ•</button></td>`;
  b.appendChild(r);
}

// --- Autocomplete ---
function auto(i){
  const box=i.nextElementSibling, v=i.value.toLowerCase();
  box.innerHTML=""; if(!v){box.style.display="none";return;}
  db.filter(x=>x.alimento.toLowerCase().includes(v)).slice(0,20).forEach(a=>{
    const d=document.createElement("div"); d.textContent=a.alimento;
    d.onclick=()=>{i.value=a.alimento;box.style.display="none";calc();}
    box.appendChild(d);
  });
  box.style.display="block";
}
document.onclick=e=>document.querySelectorAll(".autocomplete").forEach(d=>d.style.display="none");

// --- Calcolo nutrienti ---
function calc(){
  let day={c:0,cb:0,p:0,f:0};
  MEALS.forEach(([n])=>{
    let t={c:0,cb:0,p:0,f:0};
    [...document.getElementById(n+"-b").rows].forEach(r=>{
      const a=db.find(x=>x.alimento===r.cells[0].children[0].value);
      const q=+r.cells[1].children[0].value||0;
      if(a){
        const c=a.calorie*q/100,cb=a.carboidrati*q/100,p=a.proteine*q/100,f=a.grassi*q/100;
        r.querySelector(".c").textContent=c.toFixed(1);
        r.querySelector(".cb").textContent=cb.toFixed(1);
        r.querySelector(".p").textContent=p.toFixed(1);
        r.querySelector(".f").textContent=f.toFixed(1);
        t.c+=c;t.cb+=cb;t.p+=p;t.f+=f;
      }
    });
    ["c","cb","p","f"].forEach(k=>document.getElementById(`${n}-${k}`).textContent=t[k].toFixed(1));
    day.c+=t.c;day.cb+=t.cb;day.p+=t.p;day.f+=t.f;
  });
  totDay.innerHTML=`ðŸ”¥ ${day.c.toFixed(0)} kcal Â· ðŸ¥– ${day.cb.toFixed(1)} Â· ðŸ’ª ${day.p.toFixed(1)} Â· ðŸ§ˆ ${day.f.toFixed(1)}`;
  // Macro chart
  const ctx=document.getElementById("macroChart");
  if(macroChart)macroChart.destroy();
  macroChart=new Chart(ctx,{type:"doughnut",data:{labels:["Carb","Prot","Fat"],datasets:[{data:[day.cb,day.p,day.f],backgroundColor:["#60a5fa","#34d399","#f87171"]}]},options:{plugins:{legend:{position:"bottom"}}}});
  return day;
}

// --- Salvataggio ---
function saveDay(){
  const date=giornoInput.value; if(!date)return alert("Data!");
  const items=[];
  MEALS.forEach(([n])=>{
    [...document.getElementById(n+"-b").rows].forEach(r=>{
      const a=r.cells[0].children[0].value;
      const q=+r.cells[1].children[0].value||0;
      const f=db.find(x=>x.alimento===a);
      if(a&&q&&f) items.push({pasto:n,alimento:a,quantita:q,nutrienti:{cal:f.calorie*q/100,carb:f.carboidrati*q/100,prot:f.proteine*q/100,fat:f.grassi*q/100}});
    });
  });
  fetch(API+"?action=saveDay",{method:"POST",body:JSON.stringify({date,items})}).then(()=>alert("Salvato"));
}

// --- Caricamento giorno ---
function loadDay(){
  fetch(`${API}?action=getDay&date=${giornoInput.value}`)
    .then(r=>r.json())
    .then(showDay);
}
function showDay(d){
  renderMeals();
  d.forEach(i=>addRow(i.pasto,i,i.quantita));
  calc();
}

// --- Report storico ---
function report(){
  fetch(API+"?action=getAllDays").then(r=>r.json()).then(d=>{
    allDays=d; const C=[],P=[],F=[],labels=[];
    reportList.innerHTML="";
    d.forEach(x=>{
      const t=x.items.reduce((a,i)=>{a.c+=i.nutrienti.cal;a.cb+=i.nutrienti.carb;a.p+=i.nutrienti.prot;a.f+=i.nutrienti.fat;return a},{c:0,cb:0,p:0,f:0});
      labels.push(x.date); C.push(t.c); P.push(t.p); F.push(t.f);
      reportList.innerHTML+=`<span class="report-day" onclick="openDay('${x.date}')">${x.date} â†’ ${t.c.toFixed(0)} kcal</span>`;
    });
    if(chart)chart.destroy();
    chart=new Chart(chartEl,{type:"bar",data:{labels,datasets:[
      {label:"Kcal",data:C,backgroundColor:"#ff8104"},
      {label:"Carb",data:C,backgroundColor:"#3b82f6"},
      {label:"Prot",data:P,backgroundColor:"#34d370"},
      {label:"Fat",data:F,backgroundColor:"#f87171"}
    ]},options:{responsive:true,plugins:{legend:{position:"bottom"}}}});
  });
}
function openDay(d){
  giornoInput.value=d;
  showDay(allDays.find(x=>x.date===d).items);
}
const chartEl=document.getElementById("chart");

// --- Aggiungi alimento ---
function addFoodDB(){
  const a=document.getElementById("newAlimento").value.trim();
  const c=+document.getElementById("newCal").value;
  const cb=+document.getElementById("newCarb").value;
  const p=+document.getElementById("newProt").value;
  const f=+document.getElementById("newFat").value;
  if(!a||!c)return alert("Nome e Kcal obbligatori");
  const newFood={alimento:a,calorie:c,carboidrati:cb,proteine:p,grassi:f};
  db.push(newFood); // aggiorna DB locale
  fetch(API+"?action=addFood",{method:"POST",body:JSON.stringify(newFood)})
    .then(r=>r.json())
    .then(resp=>{
      alert("Alimento aggiunto correttamente!");
      renderMeals();
      document.getElementById("newAlimento").value="";
      document.getElementById("newCal").value="";
      document.getElementById("newCarb").value="";
      document.getElementById("newProt").value="";
      document.getElementById("newFat").value="";
    });
}
</script>
</body>
</html>

